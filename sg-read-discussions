// ==UserScript==
// @name         SG read discussions
// @description  Automatically mark read discussions
// @author       Bladito
// @version      0.1
// @match        https://www.steamgifts.com/discussion*
// @namespace    https://github.com/britvik/WebScripts/sg-read-discussions
// @downloadURL  https://github.com/britvik/WebScripts/sg-read-discussions
// @updateURL    https://github.com/britvik/WebScripts/sg-read-discussions
// ==/UserScript==

var storageName = 'Bladito_sg_read-discussions';

(function() {
    'use strict';

    var discussionMatch = matchDiscussion(location.href);
    var discussionsMatch = location.href.match(/.*\/discussions\/?/);

    if (discussionMatch !== null) {
        rememberReadDiscussion(discussionMatch);
    } else if (discussionsMatch !== null) {
        markReadDiscussions();
    }

})();

function matchDiscussion(url) {
    return url.match(/.*\/discussion\/(.*)\/(.*)/);
}

function rememberReadDiscussion(discussionMatch) {
    var discussion = {
        name: discussionMatch[2],
        time: new Date().getTime()
    };
    addReadDiscussion(discussionMatch[1], discussion);
}

function markReadDiscussions() {
    var linkDiscussionMatch, $this,
        readDiscussions = getReadDiscussions();

    if (readDiscussions) {
        $('a.table__column__heading').each(function() {
            $this = $(this);
            linkDiscussionMatch = matchDiscussion(this.href);
            if (readDiscussions[linkDiscussionMatch[1]]) { //we have read this discussion already
                $this.closest('.table__row-outer-wrap').css({
                    opacity: 0.3,
                    margin: '0 -20px 0 20px'
                });
                if (readDiscussions[linkDiscussionMatch[1]].name !== linkDiscussionMatch[2]) { //OP changed discussion name
                    $this.css('color', '#fd00ff');
                }
            }
        });
    }
}

function addReadDiscussion(id, discussion) {
    var readDiscussions = getReadDiscussions() || {};
    readDiscussions[id] = discussion;
    localStorage.setItem(storageName, JSON.stringify(readDiscussions));
}

function getReadDiscussions() {
    var readDiscussions = localStorage.getItem(storageName);
    if (readDiscussions) {
        return JSON.parse(readDiscussions);
    }
}
